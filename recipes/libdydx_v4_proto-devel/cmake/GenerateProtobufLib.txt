set(PROTO_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/_generated")
file(MAKE_DIRECTORY ${PROTO_BINARY_DIR})

add_library(_proto_objects OBJECT ${proto_files})
target_include_directories(_proto_objects PUBLIC ${PROTO_BINARY_DIR})

if(WIN32)
    protobuf_generate(
        TARGET _proto_objects
        PROTOC_OUT_DIR ${PROTO_BINARY_DIR}
        OUT_VAR PROTO_GENERATED_FILES
        EXPORT_MACRO DYDX_V4_PROTO_EXPORT
        LANGUAGE cpp)
else()
    protobuf_generate(
        TARGET _proto_objects
        PROTOC_OUT_DIR ${PROTO_BINARY_DIR}
        OUT_VAR PROTO_GENERATED_FILES)
endif()

add_library(dydx_v4_proto SHARED ${PROTO_GENERATED_FILES})
set_target_properties(dydx_v4_proto PROPERTIES POSITION_INDEPENDENT_CODE 1)
target_compile_definitions(dydx_v4_proto PRIVATE PROTOBUF_USE_DLLS PUBLIC PROTOBUF_USE_DLLS)
target_include_directories(dydx_v4_proto PUBLIC ${PROTO_BINARY_DIR} $ENV{PREFIX}/include $ENV{PREFIX}/Library/include)

if(WIN32)
    set_target_properties(dydx_v4_proto PROPERTIES CXX_VISIBILITY_PRESET default VISIBILITY_INLINES_HIDDEN OFF)
    target_link_directories(dydx_v4_proto PUBLIC ${CMAKE_INSTALL_PREFIX}/lib ${CMAKE_INSTALL_PREFIX}/Library/lib)
    target_link_libraries(dydx_v4_proto PUBLIC ${Protobuf_LIBRARIES} abseil_dll)
    add_link_options(/LTCG /OPT:REF /OPT:ICF)
else()
    target_link_libraries(dydx_v4_proto PUBLIC protobuf::libprotobuf)
endif()
