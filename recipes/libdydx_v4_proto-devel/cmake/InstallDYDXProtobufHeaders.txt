set(dydx_protobuf_HEADERS)
if (WIN32)
    set(EXPORT_MACRO "#ifdef _WIN32\n  #ifdef BUILDING_DLL\n    #define DLL_EXPORT_API __declspec(dllexport)\n  #else\n    #define DLL_EXPORT_API __declspec(dllimport)\n  #endif\n#else\n  #define DLL_EXPORT_API\n#endif\n")
endif()

foreach(_file ${PROTO_GENERATED_FILES})
  if(_file MATCHES ".h$")
    list(APPEND dydx_protobuf_HEADERS ${_file})
    if (WIN32)
      get_property(_has_custom_command SOURCE ${_file} PROPERTY GENERATED)
      if (NOT _has_custom_command)
        add_custom_command(
            OUTPUT ${_file}
            COMMAND ${CMAKE_COMMAND} -E echo_append "${EXPORT_MACRO}" >> ${_file}
            DEPENDS ${_file}
            COMMENT "Appending EXPORT_MACRO to ${_file}"
        )
        set_source_files_properties(${_file} PROPERTIES GENERATED TRUE)
      endif()
    endif()
  endif()
endforeach()

add_custom_target(generate_headers ALL DEPENDS ${dydx_protobuf_HEADERS})
add_dependencies(dydx_v4_proto_obj generate_headers)

install(DIRECTORY ${PROTO_BINARY_DIR}/ DESTINATION ${INCLUDE_INSTALL_DIR} COMPONENT protocol FILES_MATCHING PATTERN "*.h" PATTERN "CMakeFiles" EXCLUDE)
